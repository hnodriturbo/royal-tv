/**
 *   ========================= useSocketHub.js =========================
 * üì°
 * UNIFIED SOCKET HOOK FOR ROYAL TV:
 * Centralizes all socket actions/events for liveChat & bubbleChat features.
 * - Handles joining/leaving rooms, sending/editing/deleting messages, typing indicators.
 * - Tracks online users, unread counts, admin badges, free trials, subscriptions, etc.
 * - Provides all socket logic and event handlers as reusable methods for chat UIs.
 * =====================================================================
 */

import { useCallback } from 'react';
import useSocket from '@/hooks/socket/useSocket';

const useSocketHub = () => {
  const { socket, emit, listen, socketConnected } = useSocket();

  // 1Ô∏è‚É£ Room/Conversation
  const joinRoom = useCallback(
    (chatType, conversation_id) => {
      console.log('üì° [useSocketHub] joinRoom:', { chatType, conversation_id });
      emit('join_room', { chatType, conversation_id });
    },
    [emit]
  );
  const leaveRoom = useCallback(
    (chatType, conversation_id) => {
      console.log('üì° [useSocketHub] leaveRoom:', { chatType, conversation_id });
      emit('leave_room', { chatType, conversation_id });
    },
    [emit]
  );
  const onRoomUsersUpdate = useCallback(
    (handler) => {
      console.log('üì° [useSocketHub] Listening: room_users_update');
      return listen('room_users_update', (...args) => {
        console.log('üì° [useSocketHub] room_users_update triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );

  // 2Ô∏è‚É£ Message Events
  const sendMessage = useCallback(
    (chatType, conversation_id, message) => {
      console.log('üí¨ [useSocketHub] sendMessage:', { chatType, conversation_id, message });
      emit('send_message', { chatType, conversation_id, message: message.trim() });
    },
    [emit]
  );

  // Edit message
  const editMessage = useCallback(
    (chatType, conversation_id, message_id, message) => {
      console.log('‚úèÔ∏è [useSocketHub] editMessage:', {
        chatType,
        conversation_id,
        message_id,
        message
      });
      emit('edit_message', { chatType, conversation_id, message_id, message });
    },
    [emit]
  );

  // Delete Message
  const deleteMessage = useCallback(
    (chatType, conversation_id, message_id) => {
      console.log('üóëÔ∏è [useSocketHub] deleteMessage:', { chatType, conversation_id, message_id });
      emit('delete_message', { chatType, conversation_id, message_id });
    },
    [emit]
  );

  const receiveMessage = useCallback(
    (handler) => {
      console.log('üí¨ [useSocketHub] Listening: receive_message');
      return listen('receive_message', (...args) => {
        console.log('üí¨ [useSocketHub] receive_message triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );

  const refreshMessages = useCallback(
    (chatType, conversation_id) => {
      console.log('‚úÖ [useSocketHub] refreshMessages:', { chatType, conversation_id });
      emit('refresh_messages', { chatType, conversation_id });
    },
    [emit]
  );

  const onMessagesRefreshed = useCallback(
    (handler) =>
      listen('messages_refreshed', (payload) => {
        console.log('‚úÖ [useSocketHub] onMessagesRefreshed:', { payload });
        handler(payload); // payload: { chatType, conversation_id, messages }
      }),
    [listen]
  );
  // 4Ô∏è‚É£ Mark messages as read
  const markRead = useCallback(
    (chatType, conversation_id) => {
      console.log('‚úÖ [useSocketHub] markRead:', { chatType, conversation_id });
      emit('mark_read', { chatType, conversation_id });
    },
    [emit]
  );

  // 5Ô∏è‚É£ Send typing status to the server
  const sendTypingStatus = useCallback(
    (conversation_id, isTyping = true) => {
      emit('typing', { conversation_id, isTyping });
    },
    [emit]
  );

  // Listen for typing events from the server
  const onTyping = useCallback(
    (handler) => {
      return listen('user_typing', handler); // Handler receives { conversation_id, isTyping, name, user_id, role }
    },
    [listen]
  );

  // 6Ô∏è‚É£ Unread counts and badges
  const onUserUnreadCount = useCallback(
    (handler) => {
      console.log('üîµ [useSocketHub] Listening: user_unread_count');
      return listen('user_unread_count', (...args) => {
        console.log('üîµ [useSocketHub] user_unread_count triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );
  const onAdminUnreadCount = useCallback(
    (handler) => {
      console.log('üî¥ [useSocketHub] Listening: admin_unread_count');
      return listen('admin_unread_count', (...args) => {
        console.log('üî¥ [useSocketHub] admin_unread_count triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );
  const onUserUnreadBadge = useCallback(
    (handler) => {
      console.log('üü£ [useSocketHub] Listening: user_unread_badge');
      return listen('user_unread_badge', (...args) => {
        console.log('üü£ [useSocketHub] user_unread_badge triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );

  // 7Ô∏è‚É£ Online users
  const requestOnlineUsers = useCallback(() => {
    console.log('üåç [useSocketHub] requestOnlineUsers');
    emit('request_online_users');
  }, [emit]);

  const onOnlineUsersUpdate = useCallback(
    (handler) => {
      console.log('üü© [useSocketHub] Listening: online_users_update');
      return listen('online_users_update', (...args) => {
        console.log('üü© [useSocketHub] online_users_update triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );

  // 8Ô∏è‚É£ Account events (admin badges, trials, subs)
  const requestAccountBadges = useCallback(() => {
    console.log('üèµÔ∏è [useSocketHub] requestAccountBadges');
    emit('fetch_account_badges');
  }, [emit]);

  const onAccountBadgesUpdate = useCallback(
    (handler) => {
      console.log('üèÖ [useSocketHub] Listening: account_badges_update');
      return listen('account_badges_update', (...args) => {
        console.log('üèÖ [useSocketHub] account_badges_update triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );

  // 9Ô∏è‚É£ Free Trials events
  const requestFreeTrials = useCallback(() => {
    console.log('üéüÔ∏è [useSocketHub] requestFreeTrials');
    emit('fetch_free_trials');
  }, [emit]);

  const onFreeTrialUpdate = useCallback(
    (handler) => {
      console.log('üéüÔ∏è [useSocketHub] Listening: freeTrials_update');
      return listen('freeTrials_update', (...args) => {
        console.log('üéüÔ∏è [useSocketHub] freeTrials_update triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );

  // üîü Subscriptions events
  const requestSubscriptions = useCallback(() => {
    console.log('üóÉÔ∏è [useSocketHub] requestSubscriptions');
    emit('fetch_subscriptions');
  }, [emit]);

  const onSubscriptionsUpdate = useCallback(
    (handler) => {
      console.log('üóÉÔ∏è [useSocketHub] Listening: subscriptions_update');
      return listen('subscriptions_update', (...args) => {
        console.log('üóÉÔ∏è [useSocketHub] subscriptions_update triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );

  // üîüa) Admin: Pending (free trials and subs)
  const requestPendingFreeTrials = useCallback(() => {
    console.log('‚è≥ [useSocketHub] requestPendingFreeTrials');
    emit('fetch_pending_free_trials');
  }, [emit]);

  const onPendingFreeTrialsUpdate = useCallback(
    (handler) => {
      console.log('‚è≥ [useSocketHub] Listening: pending_freeTrials_update');
      return listen('pending_freeTrials_update', (...args) => {
        console.log('‚è≥ [useSocketHub] pending_freeTrials_update triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );

  const requestPendingSubscriptions = useCallback(() => {
    console.log('‚è≥ [useSocketHub] requestPendingSubscriptions');
    emit('fetch_pending_subscriptions');
  }, [emit]);

  const onPendingSubscriptionsUpdate = useCallback(
    (handler) => {
      console.log('‚è≥ [useSocketHub] Listening: pending_subscriptions_update');
      return listen('pending_subscriptions_update', (...args) => {
        console.log('‚è≥ [useSocketHub] pending_subscriptions_update triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );

  // ===================== NOTIFICATIONS (Admin + User) =====================

  // Emit a request to fetch notifications for current user
  const requestNotifications = useCallback(
    (user_id) => {
      if (!user_id) return;
      console.log('üîî [useSocketHub] requestNotifications', { user_id });
      emit('fetch_notifications', { user_id });
    },
    [emit]
  );
  // ==========================================================
  // üü¶ LISTEN FOR NOTIFICATIONS_LIST EVENT (FRONTEND SOCKET HUB)
  // - Handles notifications_list payloads from server and passes to hooks.
  // ==========================================================
  const onNotificationsUpdate = useCallback(
    (handler) => {
      // üü† [LOG] Set up listener for notifications_list event from server
      console.log('üü† [SOCKET HUB] Listening: notifications_list');
      return listen('notifications_list', (payload) => {
        // üü£ [LOG] Received notifications_list event payload
        console.log('üü£ [SOCKET HUB] Received notifications_list:', payload);
        handler(payload);
      });
    },
    [listen]
  );

  // Mark a notification as read (only needs notification_id)
  const markNotificationRead = useCallback(
    (notification_id) => {
      if (!notification_id) return;
      console.log('‚úÖ [useSocketHub] markNotificationRead:', { notification_id });
      emit('mark_notification_read', { notification_id });
    },
    [emit]
  );

  // 3Ô∏è‚É£ Listen for single notification push from backend (realtime trigger)
  const onNotificationReceived = useCallback(
    (handler) => {
      console.log('üü¢ [useSocketHub] Listening: notification_received');
      return listen('notification_received', (...args) => {
        console.log('üü¢ [useSocketHub] notification_received triggered:', ...args);
        handler(...args);
      });
    },
    [listen]
  );

  return {
    // üéõÔ∏è Core socket functions
    socket, // üõ†Ô∏è Used for direct socket access
    emit, // üì§ Used to send custom events
    listen, // üëÇ Used to listen for custom events
    socketConnected, // üü¢ NotificationCenter (or any consumer) can use this!

    // üè† Room events
    joinRoom, // üö™ Join chat room
    leaveRoom, // üö∂ Leave chat room
    onRoomUsersUpdate, // üßë‚Äçü§ù‚Äçüßë Listen for users in room

    // üí¨ Message events
    sendMessage, // ‚úâÔ∏è Send message
    editMessage, // ‚úèÔ∏è Edit message
    deleteMessage, // üóëÔ∏è Delete message
    receiveMessage, // üì• Receive new message

    // üóÇÔ∏è Conversation events
    refreshMessages, // emits the refresh request
    onMessagesRefreshed, // listens for the refreshed messages from backend

    // üëÅÔ∏è Read/unread events
    markRead, // ‚úÖ Mark conversation/messages as read
    onUserUnreadCount, // üîµ Listen for user's unread count
    onAdminUnreadCount, // üî¥ Listen for admin's unread count
    onUserUnreadBadge, // üü£ Listen for unread badge

    // üìù Typing events
    sendTypingStatus, // ‚å®Ô∏è Send typing status
    onTyping, // üü† Listen for typing indicator

    // üåê Online users
    requestOnlineUsers, // üåç Request list of online users
    onOnlineUsersUpdate, // üü© Listen for online users update

    // üèÖ Account/admin events
    requestAccountBadges, // üèµÔ∏è Request admin/user badge data
    onAccountBadgesUpdate, // üèÖ Listen for badge updates

    // üéÅ Free Trials
    requestFreeTrials, // üéüÔ∏è Request free trial info
    onFreeTrialUpdate, // üéüÔ∏è Listen for free trial updates

    // üìù Subscriptions
    requestSubscriptions, // üóÉÔ∏è Request subscription info
    onSubscriptionsUpdate, // üóÉÔ∏è Listen for subscription updates

    // ‚è≥ Pending
    requestPendingFreeTrials, // ‚è≥ Request pending free trials
    onPendingFreeTrialsUpdate, // ‚è≥ Listen for pending free trials update

    requestPendingSubscriptions, // ‚è≥ Request pending subscriptions
    onPendingSubscriptionsUpdate, // ‚è≥ Listen for pending subscriptions update

    // üõéÔ∏è Notifications
    requestNotifications, // üìå Request All Notifications - fetch_notifications
    onNotificationsUpdate, // üìå On Notification Update - notifications_list
    markNotificationRead, // üìå Mark notification as read - mark_notification_read
    onNotificationReceived // üìå Notification Received - notification_received
  };
};

export default useSocketHub;
